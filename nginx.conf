map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  location /_astro/ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    try_files $uri =404;
  }

  location / {
    try_files $uri $uri/ =404;
  }

  # Normalize /demo-night -> /demo-night/ so relative paths behave consistently.
  location = /demo-night {
    return 308 /demo-night/;
  }

  location /demo-night/ {
      proxy_pass https://demo-night.fly.dev/;
      # Be explicit: Fly/edge routing + TLS SNI often depend on this matching the upstream hostname.
      proxy_set_header Host demo-night.fly.dev;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Prefix /demo-night;
      proxy_ssl_server_name on;
      proxy_ssl_name demo-night.fly.dev;

      # If the upstream redirects to its own domain, keep the user under /demo-night/.
      proxy_redirect https://demo-night.fly.dev/ /demo-night/;
      proxy_redirect http://demo-night.fly.dev/ /demo-night/;

      # If the upstream sets cookies for /, scope them under /demo-night/ on this site.
      proxy_cookie_path / /demo-night/;
      
      # Handle WebSocket connections if needed
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
  }
}
